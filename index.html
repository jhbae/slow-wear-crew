<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°ê° ë°˜ì‘ ì„¤ë¬¸ì¡°ì‚¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .login-screen, .survey-screen, .result-screen, .admin-screen, .admin-login-screen {
            display: none;
        }

        .login-screen.active, .survey-screen.active, .result-screen.active, .admin-screen.active, .admin-login-screen.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .category {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .category-icon {
            font-size: 32px;
            margin-right: 12px;
        }

        .category-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .category-desc {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .question {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .question-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .radio-option {
            flex: 1;
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-option label {
            display: block;
            padding: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .radio-option input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .note-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }

        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-score {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .sensitivity {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .sensitivity.low {
            background: #d4edda;
            color: #155724;
        }

        .sensitivity.medium {
            background: #fff3cd;
            color: #856404;
        }

        .sensitivity.high {
            background: #f8d7da;
            color: #721c24;
        }

        .week-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .week-btn {
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .week-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .participant-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .participant-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-history {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .week-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .week-card.completed {
            border-color: #28a745;
        }

        @media (max-width: 600px) {
            .content {
                padding: 20px;
            }
            
            .radio-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒˆ ê°ê° ë°˜ì‘ ì„¤ë¬¸ì¡°ì‚¬</h1>
            <p>4ì£¼ê°„ ì§„í–‰ë˜ëŠ” ê°ê° ë°˜ì‘ í‰ê°€ í”„ë¡œê·¸ë¨</p>
        </div>

        <div class="content">
            <!-- ë¡œê·¸ì¸ í™”ë©´ -->
            <div class="login-screen active">
                <div class="input-group">
                    <label>ì°¸ê°€ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</label>
                    <input type="text" id="participantCode" placeholder="ì˜ˆ: P001, ê¹€ì² ìˆ˜2024">
                </div>
                <button class="btn" onclick="login()">ì‹œì‘í•˜ê¸°</button>
                <button class="btn btn-secondary" onclick="showAdmin()">ê´€ë¦¬ì í˜ì´ì§€</button>
                <div id="loginError" style="margin-top: 10px; color: #721c24; display: none;"></div>
            </div>

            <!-- ì„¤ë¬¸ í™”ë©´ -->
            <div class="survey-screen">
                <div class="week-selector" id="weekSelector"></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                
                <div id="surveyContent"></div>
                
                <button class="btn" onclick="submitSurvey()">ì œì¶œí•˜ê¸°</button>
                <button class="btn btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- ê²°ê³¼ í™”ë©´ -->
            <div class="result-screen">
                <h2 style="margin-bottom: 20px; text-align: center;">ğŸ“Š ì„¤ë¬¸ ê²°ê³¼</h2>
                <div id="resultContent"></div>
                <div class="week-history" id="weekHistory"></div>
                <button class="btn" onclick="backToSurvey()">ëŒì•„ê°€ê¸°</button>
                <button class="btn btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ -->
            <div class="admin-login-screen">
                <h2 style="margin-bottom: 20px; text-align: center;">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                <div class="input-group">
                    <label>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>
                <button class="btn" onclick="adminLogin()">ë¡œê·¸ì¸</button>
                <button class="btn btn-secondary" onclick="backToLogin()">ëŒì•„ê°€ê¸°</button>
                <div id="adminLoginError" style="margin-top: 10px; color: #721c24; display: none;"></div>
            </div>

            <!-- ê´€ë¦¬ì í™”ë©´ -->
            <div class="admin-screen">
                <h2 style="margin-bottom: 20px;">ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì í˜ì´ì§€</h2>
                
                <div class="input-group">
                    <label>ìƒˆ ì°¸ê°€ì ì½”ë“œ ìƒì„±</label>
                    <input type="text" id="newParticipantCode" placeholder="ì°¸ê°€ì ì½”ë“œ ì…ë ¥">
                </div>
                <button class="btn" onclick="addParticipant()">ì°¸ê°€ì ì¶”ê°€</button>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">ì°¸ê°€ì ëª©ë¡</h3>
                <div class="participant-list" id="participantList"></div>
                
                <button class="btn btn-secondary" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì • (ì‚¬ìš©ìê°€ ì§ì ‘ ì„¤ì •í•´ì•¼ í•¨)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // âš ï¸ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•˜ì„¸ìš”)
        const ADMIN_PASSWORD = "admin1234";  // ì´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”!

        // Firebase ì´ˆê¸°í™”
        let app, database;
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (error) {
            console.log("Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤:", error);
        }

        // ì„¤ë¬¸ ë°ì´í„°
        const surveyData = {
            categories: [
                {
                    id: 'touch',
                    icon: 'ğŸŒ¾',
                    title: '1. ì´‰ê°',
                    description: 'ì˜·, ì†ê²°, ë¹›, í•˜ì–€ì†Œ ë“± \'ë”©\'ì— ë°›ëŠ” ìê·¹ì— ëŒ€í•œ ë°˜ì‘',
                    questions: [
                        'ê½ƒì´ë‚˜ í•˜ì–€ì†Œë¥¼ ê°€ê¹Œì´ ê°€ì ¸ ê°€ë©´ í”¼í•˜ê±°ë‚˜ ë³´ëŒê¸°ë„',
                        'ë¸ŒëŸ¬ì‰¬, ì†ì§ˆì— ìŠ¬ìŠ¬ ì‘í•˜ê±° ë‚˜ ì„ë¦¼í•˜ì˜¤',
                        'íŠ¹ì • ë¶€ìœ„(ê·€, ë, ê¼¬ë¦¬ ë“±) í‹°ì¹˜ì— ë¯¼ê°í•˜ê²Œ ë°˜ì‘í•´ìš”',
                        'ì˜·ê° ì¬ì§ˆ(í„¸, ë‚˜ë¬´, ë°©ìˆ˜ì†Œ ì¬ ë“±)ì— ë”°ë¼ ë°˜ì‘ì´ ë‹¬ë¼ìš”'
                    ],
                    scoreRange: { low: [4, 6], medium: [7, 9], high: [10, 12] }
                },
                {
                    id: 'sight',
                    icon: 'ğŸ‘€',
                    title: '2. ì‹œê°',
                    description: 'ì˜·ì˜ ìƒ‰, ëª¨ì–‘, ì›€ì§ì„ ë“± \'ë³´ëŠ” ìê·¹\'ì— ëŒ€í•œ ë°˜ì‘',
                    questions: [
                        'ì˜·ì´ í¼ì³ì§€ê±°ë‚˜ í”ë“¤ë¦¬ë©´ í”¼í•˜ê±°ë‚˜ ìš¸ì–´ìš”',
                        'ì˜·ì„ ë“¤ê³  ì ‘ê·¼í•˜ë©´ ë©ˆì¶˜ë“± ë©ˆì¶”ê±°ë‚˜ ìˆ¨ì–´ìš”',
                        'ì˜·ì„ ë³´ì—¬ì£¼ë©´ í¥ê¸°ë¶„ë³´ë‹¤ ê²½ê³„ê°€ ì•ì„œìš”'
                    ],
                    scoreRange: { low: [3, 4], medium: [5, 6], high: [7, 9] }
                },
                {
                    id: 'hearing',
                    icon: 'ğŸ‘‚',
                    title: '3. ì²­ê°',
                    description: 'ì§€í¼, ë²¨í¬ë¡œ, ë‹¨ì¶” ë“± ì˜· ê´€ë ¨ ì†Œë¦¬ì— ëŒ€í•œ ë°˜ì‘',
                    questions: [
                        'ë²¨í¬ë¡œ ì°°ì§, ì§€í¼ ì†Œë¦¬ì— ë†€ ë¼ê±°ë‚˜ ì–¼ì ¸ìš”',
                        'ë‘¥ê¸€ì´ ë‚˜ëŠ” ì†Œë¦¬ì— ê·€ê°€ ê³¼ ë„í•˜ê²Œ ì›€ì§ì—¬ìš”',
                        'ì˜· ì…ëŠ” ì¤‘ê°™ì´ ìŠ¤ë¼ê°€ ë‚˜ë©´ ë°” ë¡œ ì„ë›°í•˜ìš”'
                    ],
                    scoreRange: { low: [3, 4], medium: [5, 6], high: [7, 9] }
                },
                {
                    id: 'proprioception',
                    icon: 'ğŸŒ',
                    title: '4. ê³ ìœ ê°ê°',
                    description: 'ëª¸ì´ ì¡°ì—¬ì§€ê±°ë‚˜ ì¬í•œë  ë•Œì˜ ë¶ˆí¸ê°, ì›€ì§ì„, ì¡°ì ˆ ëŠ¥ë ¥',
                    questions: [
                        'ì˜·ì„ ì…ìœ¼ë©´ ê°ˆì§€ ì•Šê±°ë‚˜ ì–¼ ë“œëŸ¬ë²„ë ¤ìš”',
                        'ì˜·ì„ ì…ì€ ì±„ ì›€ì§ì„ì´ ë‘”í•˜ ê±°ë‚˜ ë¶ˆì•ˆì •í•´ìš”',
                        'ëª‡ ê°ˆì€ ê°ˆì§€ ì•Šê³ ë„ ì›€ì„ ê³„ ì† í„¸ì–´ìš”'
                    ],
                    scoreRange: { low: [3, 4], medium: [5, 6], high: [7, 9] }
                },
                {
                    id: 'vestibular',
                    icon: 'ğŸŒŠ',
                    title: '5. ì „ì •ê°ê°',
                    description: 'ê· í˜•, ì¤‘ë ¥ê°ê°ê³¼ ê´€ë ¨ëœ ìê·¹ì— ëŒ€í•œ ë°˜ì‘',
                    questions: [
                        'ì˜·ì„ ì…ì€ ë’¤ ê°‘ìê¸° ë°©í–¥ ì „ ê°ì´ ì´ìƒí•´ìš”',
                        'ì˜· ì…ì€ ìƒíƒœì—ì„œ ì í”„ë‚˜ ê²Œ ë‹¨ ì˜¤ë¥´ê¸°ë¥¼ ë§ì„¤ë ¤ìš”',
                        'ì˜·ì„ ì…íˆê¸° ìœ„í•´ ëª¸ì„ ë“¤ê±° ë‚˜ ìì„¸ë¥¼ ë°”ê¾¸ë©´ ëª¸ì„ ë²„ë‘¥ì—¬ìš”'
                    ],
                    scoreRange: { low: [3, 4], medium: [5, 6], high: [7, 9] }
                }
            ]
        };

        let currentUser = null;
        let currentWeek = 1;
        let responses = {};

        // í™”ë©´ ì „í™˜
        function showScreen(screenName) {
            document.querySelectorAll('.login-screen, .survey-screen, .result-screen, .admin-screen, .admin-login-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.querySelector(`.${screenName}`).classList.add('active');
        }

        // ë¡œê·¸ì¸
        function login() {
            const code = document.getElementById('participantCode').value.trim();
            if (!code) {
                alert('ì°¸ê°€ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!database) {
                alert('Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                return;
            }

            database.ref('participants/' + code).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    currentUser = code;
                    localStorage.setItem('currentUser', code);
                    loadWeekSelector();
                    loadSurvey();
                    showScreen('survey-screen');
                } else {
                    alert('ë“±ë¡ë˜ì§€ ì•Šì€ ì°¸ê°€ì ì½”ë“œì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }
            });
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showScreen('login-screen');
        }

        // ì£¼ì°¨ ì„ íƒê¸° ë¡œë“œ
        function loadWeekSelector() {
            const selector = document.getElementById('weekSelector');
            selector.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const btn = document.createElement('button');
                btn.className = 'week-btn' + (i === currentWeek ? ' active' : '');
                btn.textContent = `${i}ì£¼ì°¨`;
                btn.onclick = () => selectWeek(i);
                selector.appendChild(btn);
            }
        }

        // ì£¼ì°¨ ì„ íƒ
        function selectWeek(week) {
            currentWeek = week;
            loadWeekSelector();
            loadSurvey();
        }

        // ì„¤ë¬¸ ë¡œë“œ
        function loadSurvey() {
            const content = document.getElementById('surveyContent');
            content.innerHTML = '';
            responses = {};

            // ì´ì „ ì‘ë‹µ ë¶ˆëŸ¬ì˜¤ê¸°
            if (database && currentUser) {
                database.ref(`responses/${currentUser}/week${currentWeek}`).once('value').then((snapshot) => {
                    const previousResponses = snapshot.val();
                    
                    surveyData.categories.forEach((category, catIndex) => {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'category';
                        
                        let categoryHTML = `
                            <div class="category-header">
                                <span class="category-icon">${category.icon}</span>
                                <div>
                                    <div class="category-title">${category.title}</div>
                                    <div class="category-desc">${category.description}</div>
                                </div>
                            </div>
                        `;
                        
                        category.questions.forEach((question, qIndex) => {
                            const qId = `${category.id}_${qIndex}`;
                            const prevValue = previousResponses?.categories?.[category.id]?.questions?.[qIndex]?.value || '';
                            const prevNote = previousResponses?.categories?.[category.id]?.questions?.[qIndex]?.note || '';
                            
                            categoryHTML += `
                                <div class="question">
                                    <div class="question-text">${qIndex + 1}-${catIndex + 1}. ${question}</div>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="${qId}_1" name="${qId}" value="1" ${prevValue === '1' ? 'checked' : ''}>
                                            <label for="${qId}_1">ì „í˜€ ì•„ë‹ˆë‹¤<br>(1ì )</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="${qId}_2" name="${qId}" value="2" ${prevValue === '2' ? 'checked' : ''}>
                                            <label for="${qId}_2">ê°€ë” ê·¸ë ‡ë‹¤<br>(2ì )</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="${qId}_3" name="${qId}" value="3" ${prevValue === '3' ? 'checked' : ''}>
                                            <label for="${qId}_3">ìì£¼ ê·¸ë ‡ë‹¤<br>(3ì )</label>
                                        </div>
                                    </div>
                                    <textarea class="note-input" placeholder="íŠ¹ì´ì‚¬í•­ (ì„ íƒì‚¬í•­)" id="${qId}_note">${prevNote}</textarea>
                                </div>
                            `;
                        });
                        
                        categoryDiv.innerHTML = categoryHTML;
                        content.appendChild(categoryDiv);
                    });
                    
                    updateProgress();
                });
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            const totalQuestions = surveyData.categories.reduce((sum, cat) => sum + cat.questions.length, 0);
            let answered = 0;
            
            surveyData.categories.forEach(category => {
                category.questions.forEach((_, qIndex) => {
                    const qId = `${category.id}_${qIndex}`;
                    const selected = document.querySelector(`input[name="${qId}"]:checked`);
                    if (selected) answered++;
                });
            });
            
            const progress = (answered / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // ì‘ë‹µ ìˆ˜ì§‘
        function collectResponses() {
            const data = {
                categories: {},
                timestamp: new Date().toISOString()
            };
            
            let allAnswered = true;
            
            surveyData.categories.forEach(category => {
                data.categories[category.id] = {
                    questions: [],
                    total: 0
                };
                
                category.questions.forEach((_, qIndex) => {
                    const qId = `${category.id}_${qIndex}`;
                    const selected = document.querySelector(`input[name="${qId}"]:checked`);
                    const note = document.getElementById(`${qId}_note`).value;
                    
                    if (!selected) {
                        allAnswered = false;
                    }
                    
                    const value = selected ? parseInt(selected.value) : 0;
                    data.categories[category.id].questions.push({
                        value: value,
                        note: note
                    });
                    data.categories[category.id].total += value;
                });
            });
            
            return { data, allAnswered };
        }

        // ë¯¼ê°ë„ ê³„ì‚°
        function calculateSensitivity(score, scoreRange) {
            if (score >= scoreRange.low[0] && score <= scoreRange.low[1]) return { level: 'low', text: 'ë‚®ìŒ' };
            if (score >= scoreRange.medium[0] && score <= scoreRange.medium[1]) return { level: 'medium', text: 'ë³´í†µ' };
            if (score >= scoreRange.high[0] && score <= scoreRange.high[1]) return { level: 'high', text: 'ë†’ìŒ' };
            return { level: 'medium', text: 'ë³´í†µ' };
        }

        // ì„¤ë¬¸ ì œì¶œ
        function submitSurvey() {
            const { data, allAnswered } = collectResponses();
            
            if (!allAnswered) {
                alert('ëª¨ë“  ì§ˆë¬¸ì— ë‹µí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!database || !currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            database.ref(`responses/${currentUser}/week${currentWeek}`).set(data).then(() => {
                showResults(data);
            });
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResults(data) {
            const content = document.getElementById('resultContent');
            content.innerHTML = '<h3 style="margin-bottom: 20px;">ì´ë²ˆ ì£¼ì°¨ ê²°ê³¼</h3>';
            
            surveyData.categories.forEach(category => {
                const categoryData = data.categories[category.id];
                const sensitivity = calculateSensitivity(categoryData.total, category.scoreRange);
                
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                resultCard.innerHTML = `
                    <div class="result-header">
                        <div class="result-title">
                            <span>${category.icon}</span>
                            <span>${category.title}</span>
                        </div>
                        <div class="result-score">${categoryData.total}ì </div>
                    </div>
                    <div>
                        <span class="sensitivity ${sensitivity.level}">ë¯¼ê°ë„: ${sensitivity.text}</span>
                    </div>
                `;
                content.appendChild(resultCard);
            });
            
            loadWeekHistory();
            showScreen('result-screen');
        }

        // ì£¼ì°¨ë³„ ì´ë ¥ ë¡œë“œ
        function loadWeekHistory() {
            const historyDiv = document.getElementById('weekHistory');
            historyDiv.innerHTML = '<h3 style="grid-column: 1/-1; margin-bottom: 10px;">ì£¼ì°¨ë³„ ì™„ë£Œ í˜„í™©</h3>';
            
            if (!database || !currentUser) return;
            
            database.ref(`responses/${currentUser}`).once('value').then((snapshot) => {
                const allResponses = snapshot.val() || {};
                
                for (let i = 1; i <= 4; i++) {
                    const weekCard = document.createElement('div');
                    weekCard.className = 'week-card';
                    if (allResponses[`week${i}`]) {
                        weekCard.classList.add('completed');
                    }
                    weekCard.innerHTML = `
                        <div style="font-weight: 700; margin-bottom: 5px;">${i}ì£¼ì°¨</div>
                        <div style="font-size: 12px; color: ${allResponses[`week${i}`] ? '#28a745' : '#999'};">
                            ${allResponses[`week${i}`] ? 'âœ“ ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'}
                        </div>
                    `;
                    historyDiv.appendChild(weekCard);
                }
            });
        }

        // ì„¤ë¬¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function backToSurvey() {
            showScreen('survey-screen');
        }

        // ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        function showAdmin() {
            showScreen('admin-login-screen');
        }

        // ê´€ë¦¬ì ë¡œê·¸ì¸
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('adminLoginError');
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                document.getElementById('adminPassword').value = '';
                errorDiv.style.display = 'none';
                loadParticipants();
                showScreen('admin-screen');
            } else {
                errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            }
        }

        // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ
        function adminLogout() {
            sessionStorage.removeItem('adminAuthenticated');
            showScreen('login-screen');
        }

        // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
        function checkAdminAuth() {
            return sessionStorage.getItem('adminAuthenticated') === 'true';
        }

        // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
        function loadParticipants() {
            if (!checkAdminAuth()) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                showScreen('login-screen');
                return;
            }
            
            const list = document.getElementById('participantList');
            list.innerHTML = '<div style="text-align: center; color: #999;">ë¡œë”© ì¤‘...</div>';
            
            if (!database) {
                list.innerHTML = '<div style="text-align: center; color: #721c24;">Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            database.ref('participants').once('value').then((snapshot) => {
                const participants = snapshot.val() || {};
                list.innerHTML = '';
                
                if (Object.keys(participants).length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: #999;">ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                Object.keys(participants).forEach(code => {
                    const item = document.createElement('div');
                    item.className = 'participant-item';
                    item.innerHTML = `
                        <div>
                            <strong>${code}</strong>
                            <div style="font-size: 12px; color: #666;">ê°€ì…ì¼: ${participants[code].createdAt}</div>
                        </div>
                        <button onclick="deleteParticipant('${code}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">ì‚­ì œ</button>
                    `;
                    list.appendChild(item);
                });
            });
        }

        // ì°¸ê°€ì ì¶”ê°€
        function addParticipant() {
            if (!checkAdminAuth()) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const code = document.getElementById('newParticipantCode').value.trim();
            if (!code) {
                alert('ì°¸ê°€ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!database) {
                alert('Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            database.ref('participants/' + code).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.');
                } else {
                    database.ref('participants/' + code).set({
                        createdAt: new Date().toISOString().split('T')[0]
                    }).then(() => {
                        alert('ì°¸ê°€ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        document.getElementById('newParticipantCode').value = '';
                        loadParticipants();
                    });
                }
            });
        }

        // ì°¸ê°€ì ì‚­ì œ
        function deleteParticipant(code) {
            if (!checkAdminAuth()) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm(`${code} ì°¸ê°€ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            if (!database) return;
            
            database.ref('participants/' + code).remove().then(() => {
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadParticipants();
            });
        }

        // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
        function backToLogin() {
            showScreen('login-screen');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¡œê·¸ì¸ ì‹œë„
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && database) {
                document.getElementById('participantCode').value = savedUser;
                login();
            }
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.addEventListener('change', function(e) {
                if (e.target.type === 'radio') {
                    updateProgress();
                }
            });
        };
    </script>
</body>
</html>
